<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>6 - Advanced Parameterization 路 GEMS.jl</title><meta name="title" content="6 - Advanced Parameterization 路 GEMS.jl"/><meta property="og:title" content="6 - Advanced Parameterization 路 GEMS.jl"/><meta property="twitter:title" content="6 - Advanced Parameterization 路 GEMS.jl"/><meta name="description" content="Documentation for GEMS.jl."/><meta property="og:description" content="Documentation for GEMS.jl."/><meta property="twitter:description" content="Documentation for GEMS.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.jpeg" alt="GEMS.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">GEMS.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../installation/">Installation</a></li><li><span class="tocitem">Base Model</span><ul><li><a class="tocitem" href="../base-population/">Population</a></li><li><a class="tocitem" href="../base-contacts/">Contacts</a></li><li><a class="tocitem" href="../base-disease/">Disease</a></li><li><a class="tocitem" href="../TriSM/">Interventions</a></li><li><a class="tocitem" href="../base-config/">Default Parameters</a></li></ul></li><li><span class="tocitem">Running Simulations</span><ul><li><a class="tocitem" href="../tut_Intro/">Tutorials</a></li><li><a class="tocitem" href="../tut_gettingstarted/">1 - Getting Started</a></li><li><a class="tocitem" href="../tut_exploring/">2 - Exploring Models</a></li><li><a class="tocitem" href="../tut_plotting/">3 - Plotting</a></li><li><a class="tocitem" href="../tut_batches/">4 - Running Batches</a></li><li><a class="tocitem" href="../tut_pops/">5 - Creating Populations</a></li><li class="is-active"><a class="tocitem" href>6 - Advanced Parameterization</a><ul class="internal"><li><a class="tocitem" href="#Using-Config-Files"><span>Using Config Files</span></a></li><li><a class="tocitem" href="#Using-Contact-Matrices"><span>Using Contact Matrices</span></a></li><li><a class="tocitem" href="#Age-Stratified-Disease-Progression"><span>Age-Stratified Disease Progression</span></a></li><li><a class="tocitem" href="#custom-transmission"><span>Custom Transmission Functions</span></a></li><li><a class="tocitem" href="#Immunity-and-Waning"><span>Immunity &amp; Waning</span></a></li><li><a class="tocitem" href="#Custom-Start-Conditions"><span>Custom Start Conditions</span></a></li><li><a class="tocitem" href="#custom-contacts"><span>Custom Contact Sampling</span></a></li></ul></li><li><a class="tocitem" href="../tut_postprocessing/">7 - Logging &amp; Post-Processing</a></li><li><a class="tocitem" href="../tut_reporting/">8 - Reporting</a></li><li><a class="tocitem" href="../tut_npi/">9 - Modeling Interventions</a></li><li><a class="tocitem" href="../cheat-sheet/">Cheat Sheet</a></li></ul></li><li><a class="tocitem" href="../config-files/">Config Files</a></li><li><span class="tocitem">API</span><ul><li><a class="tocitem" href="../docstrings-overview/">Overview</a></li><li><a class="tocitem" href="../api_batch/">Batches</a></li><li><a class="tocitem" href="../api_contacts/">Contacts</a></li><li><a class="tocitem" href="../api_individuals/">Individuals</a></li><li><a class="tocitem" href="../api_infections/">Infections and Immunity</a></li><li><a class="tocitem" href="../api_interventions/">Interventions</a></li><li><a class="tocitem" href="../api_logger/">Logger</a></li><li><a class="tocitem" href="../api_mapping/">Mapping</a></li><li><a class="tocitem" href="../api_misc/">Misc</a></li><li><a class="tocitem" href="../api_movie/">Movie</a></li><li><a class="tocitem" href="../api_pathogens/">Pathogens</a></li><li><a class="tocitem" href="../api_plotting/">Plotting</a></li><li><a class="tocitem" href="../api_population/">Population</a></li><li><a class="tocitem" href="../api_postproc/">Post Processing</a></li><li><a class="tocitem" href="../api_reporting/">Reporting</a></li><li><a class="tocitem" href="../api_resultdata/">Result Data</a></li><li><a class="tocitem" href="../api_settings/">Settings</a></li><li><a class="tocitem" href="../api_simulation/">Simulation</a></li></ul></li><li><a class="tocitem" href="../contributing-guide/">Contributing to GEMS</a></li><li><a class="tocitem" href="../changelog/">Changelog</a></li><li><a class="tocitem" href="../faq-page/">FAQ</a></li><li><a class="tocitem" href="../glossary/">Glossary</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Running Simulations</a></li><li class="is-active"><a href>6 - Advanced Parameterization</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>6 - Advanced Parameterization</a></li></ul></nav><div class="docs-right"><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="advanced"><a class="docs-heading-anchor" href="#advanced">6 - Advanced Parameterization</a><a id="advanced-1"></a><a class="docs-heading-anchor-permalink" href="#advanced" title="Permalink"></a></h1><p>The <code>Simulation()</code> function provides a large varitey of optional arguments to parameterize models. However, in some cases, you might want to change how disease progressions are calculated, how contacts are sampled, or how infections happen. In those cases, we use so-called <em><a href="../config-files/#config-files">config files</a></em> to pass advanced parameterizations to the GEMS engine. Config files are also useful to keep track of all your custom parameters in one file. This tutorial shows you how what you can do with them.</p><h2 id="Using-Config-Files"><a class="docs-heading-anchor" href="#Using-Config-Files">Using Config Files</a><a id="Using-Config-Files-1"></a><a class="docs-heading-anchor-permalink" href="#Using-Config-Files" title="Permalink"></a></h2><p>Config files use the <strong>*.TOML</strong> notation. When working with the <code>Simulation()</code> function to create a simulation, you can <strong>either</strong> use keyword arguments <strong>or</strong> a config file. Therefore, when you use a config file, you need to make sure that all parameters you want to pass are contained in the file. Please look up the <a href="../config-files/#config-files">config file</a> documentation to learn how to construct config files.</p><p>If you have a config file, here&#39;s how you load it in GEMS:</p><pre><code class="language-julia hljs">using GEMS
sim = Simulation(&quot;path/to/my/config-file.toml&quot;)</code></pre><h2 id="Using-Contact-Matrices"><a class="docs-heading-anchor" href="#Using-Contact-Matrices">Using Contact Matrices</a><a id="Using-Contact-Matrices-1"></a><a class="docs-heading-anchor-permalink" href="#Using-Contact-Matrices" title="Permalink"></a></h2><p>The default simulation samples contacts at random from a person&#39;s associated settings. For settings with a strong internal structure (e.g., <code>Household</code>s or <code>SchoolClass</code>es), this leads to a noticeable age-age coupling for within-setting contacts, as people who cohabit or attend the same school class tend to be of similar age. For less structured settings (e.g., <code>Municipality</code>s), GEMS offers the option to use contact matrices, i.e., from the <a href="https://journals.plos.org/plosmedicine/article?id=10.1371/journal.pmed.0050074">POLYMOD</a> study.</p><p>To use this feature, you need two things:</p><ul><li>A <code>.txt</code> file with a space-separated <code>NxN</code> contact matrix (that sums up to 1.0)</li><li>A custom config file that specifies the usage of age-based contact sampling for certain settings and links the contact matrix file.</li></ul><div class="admonition is-info" id="Example-3a013c8662657e6d"><header class="admonition-header">Example<a class="admonition-anchor" href="#Example-3a013c8662657e6d" title="Permalink"></a></header><div class="admonition-body"><p>The repository contains an <a href="https://github.com/IMMIDD/GEMS/tree/main/examples/age-based-contact-sampling">example folder</a> with a working config file and a contact matrix.</p></div></div><p>In your custom config file, specify the use of the <code>AgeBasedContactSampling</code> method for your desired settings, and provide the average number of contacts (<code>contactparameter</code>), the age-group sizes in your contact data (<code>interval</code>), and the reference to the contact data file (<code>contact_matrix_file</code>). The example below shows how to do that for the <code>GlobalSetting</code>. If you are not comfortable with where to put this, <a href="../config-files/#config-contact-sampling">here&#39;s</a> the explanation on config file layouts.</p><pre><code class="language- hljs">### Settings section of the config file ###

[Settings.GlobalSetting]
    [Settings.GlobalSetting.contact_sampling_method]
            type = &quot;AgeBasedContactSampling&quot;
            [Settings.GlobalSetting.contact_sampling_method.parameters]
                contactparameter = 1.0
                interval = 5
                contact_matrix_file = &quot;age_group_contact.txt&quot;</code></pre><p>Here&#39;s an excerpt of a contact matrix:</p><pre><code class="nohighlight hljs">1.809543958454122858e-01 1.754155024045680467e-01 ...
1.492398952058478501e-01 1.539522716226224552e-01 ...
...</code></pre><div class="admonition is-warning" id="Contact-Matrix-File-Path-cfd691ef4ec7a084"><header class="admonition-header">Contact Matrix File Path<a class="admonition-anchor" href="#Contact-Matrix-File-Path-cfd691ef4ec7a084" title="Permalink"></a></header><div class="admonition-body"><p>If you specify a relative path to your (<code>contact_matrix_file</code>) in your config file, it must be relative to your current working directory; not relative to the config file. Copy both files from the example folder directly into your current project root folder and it should work.</p></div></div><p>In the simulations below, we compare the default model (that samples random contacts in all settings) and the custom scenario where we apply age-based sampling in the <code>GlobalSetting</code>. This is the single setting that contains all individuals.  The <code>GlobalSetting</code> is switched off by default as it has a significant impact on performance and is usually only used for code-testing purposes. But here it does a good job visualizing the differences in the sampling methods.</p><pre><code class="language-julia hljs">using GEMS
default = Simulation(label = &quot;default&quot;, global_setting = true)
custom = Simulation(&quot;age-based-sampling.toml&quot;, label = &quot;custom global contacts&quot;)
run!(default)
run!(custom)
rd_d = ResultData(default)
rd_c = ResultData(custom)
gemsplot([rd_d, rd_c], type = :AggregatedSettingAgeContacts)</code></pre><p><strong>Plot</strong></p><p align="center">
    <img src="../assets/tutorials/tut_advanced_age-sampling.png" width="80%"/>
</p><p>If you compare the simulated contacts in the <code>GlobalSetting</code>, you see the difference between random sampling and the age-based sampling. However it should be noted, that the input matrix that we provide in the example folder was computer-generated and not based on empirical data. We do not recommend to use this for any real-world application.</p><h2 id="Age-Stratified-Disease-Progression"><a class="docs-heading-anchor" href="#Age-Stratified-Disease-Progression">Age-Stratified Disease Progression</a><a id="Age-Stratified-Disease-Progression-1"></a><a class="docs-heading-anchor-permalink" href="#Age-Stratified-Disease-Progression" title="Permalink"></a></h2><p>coming soon ...</p><h2 id="custom-transmission"><a class="docs-heading-anchor" href="#custom-transmission">Custom Transmission Functions</a><a id="custom-transmission-1"></a><a class="docs-heading-anchor-permalink" href="#custom-transmission" title="Permalink"></a></h2><p>GEMS&#39; default configuration assumes that each contact yields the same probability to pass on an infection and previously infected individuals are immune. However, in reality, transmission patterns might be much more complex. Custom transmission functions can be used to integrate complex dynamics.</p><p>To use this feature, you need two things:</p><ul><li>A custom <code>TransmissionFunction</code> struct and its accopanying <code>transmission_probability()</code> function that provides the rules of how transmission chances are being calculated.</li><li>a custom config file that specifies the usage of your newly created <code>TransmissionFunction</code></li></ul><p>Here&#39;s an example of a custom transmission struct and the required function. First, import the <code>GEMS.transmission_probability</code> function. Then define a new keyworded struct and make it inherit from <code>GEMS.TransmissionFunction</code>. In this struct you can define any parameters as fields that you would like to pass via a config file. In the example below, we want to differentiate transmission probability based on whether the contact happens in a household or in another setting. We thus specify a <code>household_rate</code> and a <code>general_rate</code>. An individual who was infected before shall have perfect immunity. Now define the <code>transmission_probability()</code> function for the new type. The transmission probability must return a value between <code>0</code> and <code>1</code> and is used to calculate the infection risk for each contact. A value of <code>0</code> means, the agent cannot be infected (perfect immunity). A value of <code>1</code> means, the agent will definitely be infected. Make sure that the function has the exact signature as shown below were the first argument is the new <code>TransmissionFunction</code> struct, followed by the <code>infecter</code> individual, the <code>infected</code> individual, the <code>setting</code> both individuals are currently in, and the current <code>tick</code>. All of these arguments can be used to determine the actual transmission probability.</p><pre><code class="language-julia hljs">using GEMS
using Parameters
import GEMS.transmission_probability

# define custom transmission struct
@with_kw mutable struct SettingRate &lt;: GEMS.TransmissionFunction
    household_rate::Float64
    general_rate::Float64
end

# override transmission probability function for your struct
function GEMS.transmission_probability(transFunc::SettingRate,
    infecter::Individual, infected::Individual,
    setting::Setting, tick::Int16)::Float64

    # if the agent has already been infected (natural immunity)
    if number_of_infections(infected) &gt; 0
        return 0.0
    end

    # if the contact setting is a household, return household_rate
    # and the general_rate otherwise
    return isa(setting, Household) ? transFunc.household_rate : transFunc.general_rate
end</code></pre><p>In your custom config file, specify the use of the <code>SettingRate</code> method and provide the parameters as you defined them. The example below shows the parameterization in a custom config file. If you are not comfortable with where to put this, <a href="../config-files/#config-contact-sampling">here&#39;s</a> the explanation on config file layouts.</p><pre><code class="language- hljs">### Pathogen section of the config file ###

[Pathogens]
    [Pathogens.Covid19]
        [Pathogens.Covid19.transmission_function]
            type = &quot;SettingRate&quot;
            [Pathogens.Covid19.transmission_function.parameters]
                general_rate = 0.1
                household_rate = 0.3</code></pre><div class="admonition is-info" id="Example-f7c78790210c3dec"><header class="admonition-header">Example<a class="admonition-anchor" href="#Example-f7c78790210c3dec" title="Permalink"></a></header><div class="admonition-body"><p>The repository contains an <a href="https://github.com/IMMIDD/GEMS/tree/main/examples/custom-transmission-function">example folder</a> with a working config file for the code snippet above.</p></div></div><p>Now, run a baseline simulation and one with your custom transmission function and plot the <code>:TickCasesBySetting</code>. We should see a significant difference between the number of infections that happen within and outside households.</p><pre><code class="language-julia hljs">default = Simulation(label = &quot;default&quot;)
custom = Simulation(&quot;setting-depdendent-tranmission.toml&quot;, label = &quot;custom transmission&quot;)
run!(default)
run!(custom)
rd_d = ResultData(default)
rd_c = ResultData(custom)
gemsplot([rd_d, rd_c], type = :TickCasesBySetting)</code></pre><p><strong>Plot</strong></p><p align="center">
    <img src="../assets/tutorials/tut_advanced_custom-transmission.png" width="80%"/>
</p><h2 id="Immunity-and-Waning"><a class="docs-heading-anchor" href="#Immunity-and-Waning">Immunity &amp; Waning</a><a id="Immunity-and-Waning-1"></a><a class="docs-heading-anchor-permalink" href="#Immunity-and-Waning" title="Permalink"></a></h2><p>Individuals in GEMS don&#39;t have an immunity attribute. Immunity is considered implicitly by the <code>transmission_probabilty()</code> function. Making an individual &quot;immune&quot; corresponds to having the transmission probability function return <code>0</code>, e.g., if we assume perfect natural immunity after infection and that the individual has been infected at least once. Waning (of natural immunity or vaccination protection) can be modeled the same way. All cases require the definition of a custom transmission function. We recommend doing <a href="#custom-transmission">this</a> tutorial first, if you have not yet built a custom transmission function yourself.</p><p>For this example, we want an individual to have natural immunty against a pathogen after infection for exactly 50 days. The example below shows a custom transmission function including that rule. The <code>FixedWaning</code> struct takes two parameters. A <code>rate</code> representing the infection probability if no immunity applies and a <code>waning_time</code> specifying the duration of immunity after recovery.</p><pre><code class="language-julia hljs">using GEMS
using Parameters
import GEMS.transmission_probability

# define custom transmission struct
@with_kw mutable struct FixedWaning &lt;: GEMS.TransmissionFunction
    rate::Float64
    waning_time::Int64
end

# override transmission probability function for your struct
function GEMS.transmission_probability(transFunc::FixedWaning,
    infecter::Individual, infected::Individual,
    setting::Setting, tick::Int16)::Float64

    # if never infected before, usual rate applies
    if number_of_infections(infected) == 0
        return transFunc.rate
    end

    # calculate until when individual is immune if he was previously infected
    immune_until = removed_tick(infected) + transFunc.waning_time
    
    # if waning date is in the future, return 0 as transmission probability,
    # else, return provided rate
    return immune_until &gt; tick ? 0.0 : transFunc.rate
end</code></pre><p>We also need a custom config file to incorporate the new rules in our simulation. In your custom config file, specify the use of the <code>FixedWaning</code> method and provide the parameters as you defined them. The example below shows the parameterization in a custom config file. If you are not comfortable with where to put this, <a href="../config-files/#config-contact-sampling">here&#39;s</a> the explanation on config file layouts.</p><pre><code class="language- hljs">### Pathogen section of the config file ###

[Pathogens]
    [Pathogens.Covid19]
        [Pathogens.Covid19.transmission_function]
            type = &quot;FixedWaning&quot;
            [Pathogens.Covid19.transmission_function.parameters]
                rate = 0.2
                waning_time = 50</code></pre><div class="admonition is-info" id="Example-f2e6f31f693b7ea6"><header class="admonition-header">Example<a class="admonition-anchor" href="#Example-f2e6f31f693b7ea6" title="Permalink"></a></header><div class="admonition-body"><p>The repository contains an <a href="https://github.com/IMMIDD/GEMS/tree/main/examples/fixed-waning">example folder</a> with a working config file for the code snippet above.</p></div></div><p>Run a simulation as such and inspect the results:</p><pre><code class="language-julia hljs">sim = Simulation(&quot;fixed-waning.toml&quot;)
run!(sim)
rd = ResultData(sim)
gemsplot(rd)</code></pre><p><strong>Plot</strong></p><p align="center">
    <img src="../assets/tutorials/tut_advanced_fixed-waning.png" width="80%"/>
</p><p>The plots show oscillating behavior of the daily infections and the effective reproduction number as individuals are becoming susceptible again a few weeks after their initial infection.</p><h2 id="Custom-Start-Conditions"><a class="docs-heading-anchor" href="#Custom-Start-Conditions">Custom Start Conditions</a><a id="Custom-Start-Conditions-1"></a><a class="docs-heading-anchor-permalink" href="#Custom-Start-Conditions" title="Permalink"></a></h2><p>coming soon ...</p><h2 id="custom-contacts"><a class="docs-heading-anchor" href="#custom-contacts">Custom Contact Sampling</a><a id="custom-contacts-1"></a><a class="docs-heading-anchor-permalink" href="#custom-contacts" title="Permalink"></a></h2><p>coming soon ...</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../tut_pops/">芦 5 - Creating Populations</a><a class="docs-footer-nextpage" href="../tut_postprocessing/">7 - Logging &amp; Post-Processing 禄</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Thursday 16 October 2025 12:05">Thursday 16 October 2025</span>. Using Julia version 1.11.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
